---
title: "Reproducible Science and Figure in R"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## QUESTION 01: Data Visualisation for Science Communication

### a) Provide your figure here:

```{r loading in the data and packages, message=FALSE, warning=FALSE, include=FALSE}

options(repos = c(CRAN = "https://cran.r-project.org/"))

install.packages("ggplot2")
install.packages("dplyr")
install.packages("palmerpenguins")
install.packages("janitor")

library(ggplot2)
library(dplyr)
library(palmerpenguins)
library(janitor)

source("functions/cleaning.r")

```

```{r bad figure code, echo=FALSE, message=FALSE, warning=FALSE}

penguins_clean <- penguins_raw %>%
    clean_column_names() %>%
    shorten_species() %>%
    remove_empty_columns_rows()

ggplot(data = penguins_clean, aes(x = body_mass_g, y = flipper_length_mm, colour = species)) +
  scale_colour_manual(values = c("#21AAF3","blue", "#1C92D0")) +
   geom_smooth(method = "lm", se = FALSE, color = "cyan", linewidth = 2) +
  geom_point(size = 5) +
  scale_x_continuous(limits = c(2000, 7000)) +
  scale_y_continuous(limits = c(180, 220)) +
  labs(title = "Graph", x = "Flipper Length (m)", y = "Body Mass (kg)") +
  theme(legend.position = "none")

```

### b) Write about how your design choices mislead the reader about the underlying data (200-300 words).

Here I have plotted a graph from the palmerpenguins dataset, comparing flipper length against body mass to investigate their linear relationship. However, the design choices I have made to plot the graph have resulted in a figure that is both misleading and confusing. Firstly, the graph is not appropriately labelled. There is no title and the axes labels are the wrong way around with the incorrect units. The axes should state: x = Body Mass (g), and y = Flipper lengh (mm), because of this, the displayed graph is a complete misrepresentation of the true relationship. The points on the scatter plot are enlarged such that the points overlap, reducing the clarity of the data spread and misrepresenting the number of points it also prevents the reader from identifying the exact position of each point. Although the points are colour coordinated to species, not only are the colours too similar to distinguish, but there is also no legend so the reader could not make use of this information. The scaling may be the biggest error in design choice. The axes are scaled very differently with the x-axis spanning 2000-7000 and y-axis between 180-220. The axes breaks are mis-representative of this difference in scale which makes the relationship appear much stronger than it may actually be. The y-axis is bounded such that data is cropped from either extreme and forced onto the limits. By forcing the data into these bounds, a relationship is manually forced and misleads the reader. The regression line plotted on the graph is embedded behind the data points and is essentially not visible, seeing as this graph is set to investigate the linear relationship, with the regression not visible and no provided information on the correlation coefficients, no satisfactory conclusions can be drawn.

## QUESTION 2: Data Pipeline

## Introduction

Presented with the palmerpenguins dataset, I begin a data analysis to investigate the relationship between body mass and flipper length, considering the influence of species. The first step in data exploration is to install and load all the relevant packages. These packages include ggplot2 (to produce graphs), janitor (to help clean the dataset), dplyr (which allows us to use the pipe function), and palmerpenguins (which provides the dataset). This is done below:

```{r Data Exploration, warning=FALSE}

install.packages("ggplot2")
install.packages("dplyr")
install.packages("palmerpenguins")
install.packages("janitor")

library(ggplot2)
library(dplyr)
library(palmerpenguins)
library(janitor)
```

The next step is to investigate the raw data set that is already termed penguins_raw from the palmerpenguins package. By using the head() function, the dataset can be observed such that the aspects that require cleaning can be identified. 
```{r warning=FALSE}
head(penguins_raw)
```

From the output, there are multiple noticable aspects of this dataset that need to be cleaned before further analysis. These are:
- The column names need to be changed so they are machine readable (lower and snake case) - this is done through the function 'clean_column_names'. 
- Any empty column or row should be removed - this is done through the function remove_empty_column_names. 
- The final three columns are not relevant and should be removed from the dataset - this is done through the functions select()
- The species names should be shortened - this is done through the function shorten_species()
- In order to only include the data of interest, the other columns can be removed by using subset_columns()

All of these cleaning functions are done below through a pipeline, defining a new object 'penguins_clean' which will be the newly cleaned dataset:

```{r warning=FALSE}

source("functions/cleaning.r") #R file containing the defined functions that are used below (this can be found in the repository)

penguins_clean <- penguins_raw %>%
    clean_column_names() %>%
    shorten_species() %>%
    remove_empty_columns_rows() %>%
    select(-starts_with("Delta")) %>%
    select(-comments) %>%
    subset_columns(c("species", "body_mass_g", "flipper_length_mm"))
 
head(penguins_clean)
```

Now that the dataset has been cleaned, a graph can be plotted to observe the data. Using ggplot, a scatterplot can be made to show the relationship between flipper length and body mass, seperating the species by colour. The code for this is below:
```{r - Plottoing the exploratory figure, warning=FALSE}
ggplot(data = penguins_clean, aes(x = body_mass_g, y = flipper_length_mm, colour = species)) +
  geom_point() +
  labs(title = "Body Mass plotted against Flipper length in all penguins", x = "Body Mass (g)", y = "Flipper Length (mm)") +
  geom_smooth(method = "lm", se = TRUE, aes(group = 1), color = "black") +
  theme_bw()
```

## Hypothesis

Based on the appearance of the exploratory graph and the plotted line of best fit, I formulate the hypothesis that flipper length increases with body mass, in other words, body mass explains some of the variation in flipper. This hypothesis supported by the apparent directly proportional relationship. This can be tested by investigating if there is a positive linear relationship between these variables. As such the hypothesis follows: 
Null hypothesis (H0): R\^2 = 0 - A coefficient of determination = 0 would suggest that body mass explains none of the variation in flipper length. 
Alternative hypothesis (H1): R\^2 \> 0 - A coefficient of determination \> 0 would suggest that body mass explains a non-zero amont of the variation in flipper length.

Further I hypothesise that the species influences the relationship between body mass and flipper length as the trend of points seems to differ slightly between each colour distinguished species. An interaction between a categorical value such as 'species' and a covariate such as 'body mass' would determine if the species does influence this relationship. Therefore the hypotehsis can be set as:
Null hypothesis (H0): There is no interaction between species and body mass
Alternative hypothesis (H1): There is a non-zero effect of the interaction between species and body mass.

## Statistical Methods

The appropriate statistical test to investigate this relationship would be finding the coefficient of determination (R^2) in a linear model between these two variables. An F-test of overall significance can then be used to determine whether the found relationship is truly significant. All of these tests are conducted through the linear model function (lm()):

```{r Statistics - Linear Model, warning=FALSE}
linear_model <- lm(data = penguins_clean, flipper_length_mm ~ body_mass_g)
summary(linear_model)
```

To test the second hypothesis, first to investigate the influence of species on this relationship. I run new linear models to find the R^2 values for each different species.

Next, in order to test the significance of the influence of species for this relationship, I can use the r package "car" which allows for the use of ANCOVA tests. The interaction between body mass and species in this model well help determine if the relationship between body mass and flipper length is different between species.

This is done below:

```{r - ANCOVA, warning=FALSE}

# Creating linear models for each individual penguin species can be achieved by subseting the data further into species specific datasets from which the models can be made. This is done below:

# Creating a linear model for just the Adelie penguin data
adelie_data <- penguins_clean %>% 
  filter_by_species("Adelie")
linear_adelie <- lm(data = adelie_data, flipper_length_mm ~ body_mass_g)
summary(linear_adelie)
# This produces an R^2 value of 0.214 at a significant P-value of 1.343e-09

# Creating a linear model for just the Chinstrap penguins
chinstrap_data <- penguins_clean %>% 
  filter_by_species("Chinstrap")
linear_chinstrap <- lm(data = chinstrap_data, flipper_length_mm ~ body_mass_g)
summary(linear_chinstrap)
# This produces an R^2 value of 0.4027 at a significant P-value of 3.748e-09

# Creating a linear model for just the Gentoo penguins
gentoo_data <- penguins_clean %>% 
  filter_by_species("Gentoo")
linear_gentoo <- lm(data = gentoo_data, flipper_length_mm ~ body_mass_g)
summary(linear_gentoo)
# This produces an R^2 value of 0.4896 at a significant P-value of less than 2.23-16


# Below the car package is installed an used to conduct an ANCOVA test for the interaction between species and this linear relationship
install.packages("car")
library(car)
ancova_model <- aov(flipper_length_mm ~ body_mass_g + species, data = penguins_clean)
summary(ancova_model)
```

## Results & Discussion

### Linear model analysis

The summary table from that linear regression stats test provides a lot of information on the plotted relationship. However, for the sake of the first hypothesis, the most important value is the adjusted R-squared. The adjusted R-sqaured value accounts for any overfitting from the regular R-squared. R-squared is a measure of how well the independent variable in the linear regression explains the variability of the dependent variable. In this context, 'Adjusted R-squared' is used to measure how much of the variation in flipper length is explained by body mass. R-squared values are bound between 0 and 1, higher values indicate stronger relationships. 

#### The results of the linear regression produce an Adjusted R-squared value of 0.7583. The high value demonstrates a very strong relationship, suggesting that body mass explains a lot of the variation in flipper length. Additionally, the significance of this value is supported by the provided F-test which produces a p-value < 2.2e-16 which is much smaller than 0.05. This allows us to reject the null hypothesis and claim that the relationship is not likely due to chance.

For full visibility, the initial graph is plotted again, this time only focussing on the tested relationship. The results of the stats test are also projected. The code for the graph is shown below:

```{r Plotting linear model results, warning=FALSE}
ggplot(data = penguins_clean, aes(x = body_mass_g, y = flipper_length_mm)) +
  geom_point() +
  labs(title = "Body Mass plotted against Flipper length in all penguins", x = "Body Mass (g)", y = "Flipper Length (mm)") +
  geom_smooth(method = "lm", se = TRUE, aes(group = 1), color = "red") +
  theme_bw() +
  geom_label(aes(x = 5500, y = 188), hjust = 0, label = paste("Adj R2 = ",signif(summary(linear_model)$adj.r.squared, 5),
                                               "\nIntercept =",signif(linear_model$coef[[1]],5 ),
                                               " \nSlope =",signif(linear_model$coef[[2]], 5),
                                               " \nP =",signif(summary(linear_model)$coef[2,4], 5)))
```

### ANCOVA analysis

#### The second hypothesis is tested using an ANCOVA statistical test where the interaction between species and body mass is measured. The ANCOVA summary table is interpreted by regarding the significance of the p value of the interaction (in this case, the interaction is considered in the 'species' row). The p value of the interaction < 2e-16. As this value is signficant, there is evidence to suggest that the relationship between body mass and flipper length is different across different species. As such, the null hypothesis can be rejected. 

Likewise, to give a visual demonstration of this result, the graph is plotted once more, this time showing the relationships for each individual species.

```{r Plotting ANCOVA results, warning=FALSE}
ggplot(data = penguins_clean, aes(x = body_mass_g, y = flipper_length_mm, colour = species)) +
  geom_point() +
  labs(title = "Body Mass plotted against Flipper length by species", x = "Body Mass (g)", y = "Flipper Length (mm)") +
  geom_smooth(method = "lm", aes(group = species, color = species), se = TRUE) +
  theme_bw() +
  geom_label(aes(x = 5500, y = 182), hjust = 0, label = paste("Adj R2 = ",signif(summary(linear_adelie)$adj.r.squared, 5),
                                               " \nP =",signif(summary(linear_adelie)$coef[2,4], 5)),
             inherit.aes = FALSE, colour = "red") +
  geom_label(aes(x = 5500, y = 190), hjust = 0, label = paste("Adj R2 = ",signif(summary(linear_chinstrap)$adj.r.squared, 5),
                                               " \nP =",signif(summary(linear_chinstrap)$coef[2,4], 5)),
             inherit.aes = FALSE, colour = "green") +
  geom_label(aes(x = 5500, y = 198), hjust = 0, label = paste("Adj R2 = ",signif(summary(linear_gentoo)$adj.r.squared, 5),
                                               " \nP =",signif(summary(linear_gentoo)$coef[2,4], 5)),
             inherit.aes = FALSE, colour = "blue")
```

## Conclusion

#### This leads to the conclusion that body mass explains variation in flipper length and those penguins with larger body mass are more likely to have longer flippers. This conclusion would be expected as greater body masses usually indicate larger birds and given that both of these measures are of morphological features, it makes sense that flipper length will increase as body mass increases. This strong positive relationship is observed in all 3 penguin species. However, the results of the ANCOVA test suggest that the there is a significant interaction between species and this relationship. This suggests that the type of species a penguin is, will have a significant influence on the relationship between body mass and flipper length. Likewise, this conclusion would also be expected as different species are expected to have different developmental patterns and growth is likely to be more similar within species than between.

# QUESTION 3: Open Science

### a) GitHub

Link to github repository:

<https://github.com/hiddenuser884/Reproducible-figures.git>

### b) Share your repo with a partner, download, and try to run their data pipeline.

<https://github.com/user801259/Reproducible-data.git>

### c) Reflect on your experience running their code. (300-500 words)

-   *What elements of your partner's code helped you to understand their data pipeline?*

Throughout the entire data pipeline, my partner annotated their code such that every step was properly explained. They explained their motivations and goals for each step alongside an explanation of what their actual code would achieve. This allowed me to have a complete understanding of both what they were attempting to do and how they went about investigating the data. They provided an analysis of the results of their statistical tests and explanations to the produced figures which were key in my interpretation of the results. The pipeline is split up in seperate coding chunks so that the subsequent steps can be distinguished.

-   *Did it run? Did you need to fix anything?*

The code itself ran perfectly and there was no need for intervention to produce the intended figures and results.

-   *What suggestions would you make for improving their code to make it more understandable or reproducible, and why?*

The main amendment I would suggest for this code would be to improve the clarity of the pipeline. Although the code is split in chunks for each overall section (introduction, statistical methods, conclusions), there is not a clear indication of hypothesis as it just lies within a body of text. It would be more clear to create a new subheading under the name hypothesis where the hypothesis is stated. Similarly, the results and disucssion section is not clearly titled. Further, the code chunks could be separated such that each chunk represents all the same analysis. For instance, in the results chunk I would recommend the statistical analysis and ensuing discussion to be separated into two chunks for the two analyses (linear model and anova test). The discussion text is displayed as notes of the code rather than written outside the chunks. This could be misinterpreted as notes on the code rather than a discussion of the results. I would recommend moving this text to outside the r chunks (similar to the conclusion text) so it is more readable. This would help make the code more reproducible due to clairty. Another amendement would be to the code plotting the graph representing the linear model. Currently, although the graph well represents the investigated trend, the results of the stats test are slightly overlapped by the data points making them harder to read. I would adjust the code such that these values (in particular R^2, and P value) are displayed more clearly. 

-   *If you needed to alter your partner's figure using their code, do you think that would be easy or difficult, and why?*

If I needed to alter my partners figure using their code, it would be very easy to navigate to the correct location to make the appropriate adjustments. This is because they annotated the figure code such that each step is explained, highlighting what each line does to contribute to the produced figure. However, given that the notes and lines of code are slightly cramped, there is a possibility for misinterpretation for which notes corresponds to which line of code. That being said, a pre-existing knowledge of how the code works would remove the risk of most of these errors. 

### d) Reflect on your own code based on your experience with your partner's code and their review of yours. (300-500 words)

-   *What improvements did they suggest, and do you agree?*

My partner suggested a variety of improvements to my code, these are as follows:
- Make narrative more concise: One of the main adjustments suggested by my partner was to make my narrative text more concise, especially with regards to discussion and hypothesis. By reducing length to only include the key points it may help make my work more clear. However, sufficient justification and explanation is also necessary for the readers understanding. Cropping too much may lead to work that is harder to understand without specific pre-existing knowledge of the field. Therefore, an appropriate improvement to my code would be to redraft my text in a way that clearly and efficiently communicates my points without being too verbose.
- Annotate individual code: My partner suggested that I should include more notes to address what each line of code does in my work. This applies most directly to the code constructing graphs. In this case I would agree that by annotating this code and explaining what each component does, it would improve the accessibility of others to adjust the graphs to their need. There is a certain degree ot 'clutter' that should be avoided if notes on graphs are too descriptive, however, short notes such as 'code to plot regression line' would certainly improve the reproducability of this work. 
- A final improvement suggested is to address the relevance of the statistical analysis for my ANCOVA model. While I ran 3 linear models to produce comparable species-specific relationship values, the relevance of this may not be clear. The products of these linear models are displayed on the final graph, but they are not required to run the ANCOVA test. Therefore, to improve my work, I would address the purpose of these linear models more clearly and perhaps move the code down to the results summary.

Overall, I agree with the majority of improvements suggested by my partner. I feel that my code was well constructed and clearly communicates the pipeline of my analysis, reaching results that are clearly observed in the produced figures. However, following my partners review, I could improve the clarity of my annotation by making my comments more concise and addressing the purpose of all relevant code. 

-   *What did you learn about writing code for other people?*

In this exercise I learnt that writing code intended to be reproducible by others is an important and useful practice. Writing code for others necessitates detailed documentation and annotation of all the work a researcher produces. By keeping a clear documentation of our work, we ensure that code can be explained and understood, reducing the chances of misinterpretation or misuse by others. User-friendly formatting and accessible platforms to share work, such as GitHub, makes communication between researchers more efficient. This establishes a more streamlined practice of scientific work whereby an open science perspective is encouraged. A transparent researcher-centric approach to producing work improves the free flow of information, allowing researchers benefit from improved recognition of their work (McKiernan et al., 2016). Through peer reviews and collaboration, this perspective is likely to enhance our developments in scientific understanding. 


Bibliography:

McKiernan, E. C., Bourne, P. E., Brown, C. T., Buck, S., Kenall, A., Lin, J., McDougall, D., Nosek, B. A., Ram, K., Soderberg, C. K., Spies, J. R., Thaney, K., Updegrove, A., Woo, K. H., & Yarkoni, T. (2016). How open science helps researchers succeed. ELife, 5(JULY). https://doi.org/10.7554/ELIFE.16800
